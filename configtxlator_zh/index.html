<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Hyperledger国际化工作组">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Channel 重新配置(configtxlator) - Hyperledger中文文档</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Channel \u91cd\u65b0\u914d\u7f6e(configtxlator)";
    var mkdocs_page_input_path = "configtxlator_zh.md";
    var mkdocs_page_url = "/configtxlator_zh/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Hyperledger中文文档</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">欢迎</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../glossary/">词汇表</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../blockchain_zh/">简介</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../getting_started/">快速入门</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../protocol-spec_zh/">协议规范</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Fabric教程</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../build_network_zh/">构建第一个fabric网络</a>
                </li>
                <li class="">
                    
    <a class="" href="../write_first_app_zh/">编写第一个应用</a>
                </li>
                <li class="">
                    
    <a class="" href="../channel_update_zh/">重新配置第一个网络</a>
                </li>
                <li class="">
                    
    <a class="" href="../chaincode_zh/">Chaincode 指南</a>
                </li>
                <li class="">
                    
    <a class="" href="../chaincode_developers_zh/">Chaincode 开发手册</a>
                </li>
                <li class="">
                    
    <a class="" href="../chaincode_operators_zh/">Chaincode 操作手册</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Fabric操作指南</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../msp_zh/">MSP</a>
                </li>
                <li class="">
                    
    <a class="" href="../configtx_zh/">Channel 配置(configtx)</a>
                </li>
                <li class="">
                    
    <a class="" href="../configtxgen_zh/">Channel 配置(configtxgen)</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Channel 重新配置(configtxlator)</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#configtxlator">用configtxlator重新配置</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#_1">概述</a></li>
        
            <li><a class="toctree-l4" href="#configtxlator_1">运行configtxlator</a></li>
        
            <li><a class="toctree-l4" href="#proto">Proto转换</a></li>
        
            <li><a class="toctree-l4" href="#_2">配置更新计算</a></li>
        
            <li><a class="toctree-l4" href="#_3">自举例子</a></li>
        
            <li><a class="toctree-l4" href="#_4">重新配置的例子</a></li>
        
            <li><a class="toctree-l4" href="#_5">增加一个组织</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../endorsement-policies_zh/">背书策略</a>
                </li>
                <li class="">
                    
    <a class="" href="../error-handling_zh/">错误处理</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging-control_zh/">日志控制</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Fabric设计</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../arch-deep-dive_zh/">架构说明</a>
                </li>
                <li class="">
                    
    <a class="" href="../txflow_zh/">交易流程</a>
                </li>
                <li class="">
                    
    <a class="" href="../ca-setup_zh/">CA</a>
                </li>
                <li class="">
                    
    <a class="" href="../sdk_node_zh/">SDK--node</a>
                </li>
                <li class="">
                    
    <a class="" href="../sdk_java_zh/">SDK--java</a>
                </li>
                <li class="">
                    
    <a class="" href="../kafka_zh/">基于kafka的排序服务</a>
                </li>
                <li class="">
                    
    <a class="" href="../channels_zh/">Channels</a>
                </li>
                <li class="">
                    
    <a class="" href="../ledger_zh/">账本</a>
                </li>
                <li class="">
                    
    <a class="" href="../read-write-set/">Read-Write set</a>
                </li>
                <li class="">
                    
    <a class="" href="../gossip_zh/">Gossip数据传输协议</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">故障排除和常见问题</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Fabric-FAQ/">Hyperledger Fabric 答疑</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../msp_acl_zh/">MSP&ACL</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../sdk-design_zh/">Fabric SDK 设计</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../makefile_zh/">Makefile文件解析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../blockchain-crypto-service-provider_zh/">BCCSP密码算法套件解析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../zanata_guide/">Zanata使用指南</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Hyperledger中文文档</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Fabric操作指南 &raquo;</li>
        
      
    
    <li>Channel 重新配置(configtxlator)</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/HyperledgerCN/hyperledgerDocs/edit/master/docs/configtxlator_zh.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="configtxlator">用configtxlator重新配置<a class="headerlink" href="#configtxlator" title="Permanent link">&para;</a></h2>
<p><a href="http://hyperledger-fabric.readthedocs.io/en/latest/configtxlator.html">原文</a>  </p>
<h3 id="_1">概述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>创建<code>configtxlator</code>工具的目的是支持不依赖SDK的重新配置。通道配置被当作一个交易存储在通道的配置区块中，可以被直接操作，如在bdd行为测试中。不过，在撰写本文时，SDK本身不支持直接操作配置，因此该configtxlator工具旨在提供API，供任何SDK的使用者与之交互以协助配置更新。</p>
<p>工具名称是configtx和translator的混合，旨在表达该工具只是在两者之间进行转换。它不会生成配置。它不递交或检索配置。它不会自己修改配置，它只是在configtx格式的不同视图之间提供一些双向操作。</p>
<p>标准用法为：</p>
<ol>
<li>SDK检索最新的配置  </li>
<li><code>configtxlator</code> 产生人类可读的配置版本  </li>
<li>用户或应用程序编辑配置  </li>
<li><code>configtxlator</code>用于计算配置的变更  </li>
<li>SDK递交签名和递交配置  </li>
</ol>
<p><code>configtxlator</code>工具暴露了一个真正的无状态的REST API来与配置元素进行交互。这些REST组件支持将原生配置格式转换为人类可读的JSON格式，或者根据两种配置之间的差异来计算配置变更。</p>
<p>由于<code>configtxlator</code>服务故意不包含任何密钥材料或其他秘密信息，因此不包含任何授权或访问控制。预期的典型部署将在本地与应用程序一起作为沙盒容器来运行，因而<code>configtxlator</code>是个为消费者提供的专用进程。</p>
<h3 id="configtxlator_1">运行configtxlator<a class="headerlink" href="#configtxlator_1" title="Permanent link">&para;</a></h3>
<p><code>configtxlator</code>工具可以与其他Hyperledger Fabric平台相关的二进制文件一起下载。 详细信息查看download-platform-specific-binaries。</p>
<p>该工具可能被配置为侦听不同的端口，您也可以使用<code>--port</code>和<code>--hostname</code>标志来指定主机名。要查看完整的命令和标志，请运行<code>configtxlator --help</code>。</p>
<p>该二进制包将启动一个监听指定端口的http服务器，然后就可以处理请求了。</p>
<p>要启动<code>configtxlator</code>服务器：</p>
<pre><code>$ configtxlator start
2017-06-21 18:16:58.248 HKT [configtxlator] startServer -&gt; INFO 001 Serving HTTP requests on 0.0.0.0:7059
</code></pre>

<h3 id="proto">Proto转换<a class="headerlink" href="#proto" title="Permanent link">&para;</a></h3>
<p>为了扩展性，并且由于某些字段必须被签名，许多proto字段被存储为字节。这使得无法使用<code>jsonpb</code>包来完成原生proto到JSON的翻译。作为代替，<code>configtxlator</code>暴露了一个REST组件来做更复杂的翻译。</p>
<p>为了将proto转换为人类可读的JSON等价物，只需将二进制proto发布到REST地址<code>http://$SERVER:$PORT/protolator/decode/&lt;message.Name&gt;</code>，其中<code>&lt;message.Name&gt;</code>是消息的完全限定的proto名称。</p>
<p>例如，要解码一个配置区块并另存为<code>configuration_block.pb</code>，请运行以下命令：:</p>
<pre><code>$ curl -X POST --data-binary @configuration_block.pb http://127.0.0.1:7059/protolator/decode/common.Block
</code></pre>

<p>为了转换人类可读JSON版本的prot消息，只需要把JSON消息发送到<code>http://$SERVER:$PORT/protolator/encode/&lt;message.Name</code>，这里<code>&lt;message.Name&gt;</code>仍然是消息的完全限定的proto名称。<br />
例如，重编码区块另存为<code>configuration_block.json</code>，运行命令：</p>
<pre><code>$ curl -X POST --data-binary @configuration_block.json http://127.0.0.1:7059/protolator/encode/common.Block
</code></pre>

<p>任何配置相关proto，包括<code>common.Block</code>、<code>common.Envelope</code>、<code>common.ConfigEnvelope</code>、<code>common.ConfigUpdateEnvelope</code>
、<code>common.Config</code>和<code>common.ConfigUpdate</code>都是这些URL有效目标。未来，可能会增加其它proto编码类型，如背书者交易。  </p>
<h3 id="_2">配置更新计算<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>给定两种不同的配置，可以计算在它们之间转换的配置更新。只需将两个<code>common.Config</code>proto编码的配置作为<code>multipart/formdata</code>、original作为字段<code>original</code>和updated作为字段<code>updated</code>，发送到<code>http://$SERVER:$PORT/configtxlator/compute/update-from-configs</code>。</p>
<p>例如，给定原始配置文件<code>original_config.pb</code>和更新的配置文件<code>updated_config.pb</code>，对于通道<code>desiredchannel</code>：</p>
<pre><code>$ curl -X POST -F channel=desiredchannel -F original=@original_config.pb -F updated=@updated_config.pb http://127.0.0.1:7059/configtxlator/compute/update-from-configs
</code></pre>

<h3 id="_3">自举例子<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>启动<code>configtxlator</code>:</p>
<pre><code>$ configtxlator start
2017-05-31 12:57:22.499 EDT [configtxlator] main -&gt; INFO 001 Serving HTTP requests on port: 7059
</code></pre>

<p>首先，为排序系统通道生成一个创世区块：</p>
<pre><code>$ configtxgen -outputBlock genesis_block.pb
2017-05-31 14:15:16.634 EDT [common/configtx/tool] main -&gt; INFO 001 Loading configuration
2017-05-31 14:15:16.646 EDT [common/configtx/tool] doOutputBlock -&gt; INFO 002 Generating genesis block
2017-05-31 14:15:16.646 EDT [common/configtx/tool] doOutputBlock -&gt; INFO 003 Writing genesis block
</code></pre>

<p>将创世区块解码为人类可编辑格式：</p>
<pre><code>$ curl -X POST --data-binary @genesis_block.pb http://127.0.0.1:7059/protolator/decode/common.Block &gt; genesis_block.json
</code></pre>

<p>编辑生成的文件<code>genesis_block.json</code>，或者用程序操作它。这里我们使用JOSN CLI工具<code>jq</code>。为了简单，我们编辑通道的批大小，因为它是个简单的数字。然而，所有都可以编辑，包括策略和MSP。</p>
<p>首先，让我们建立一个环境变量来保存指向json中属性的路径：</p>
<pre><code>$ export MAXBATCHSIZEPATH=&quot;.data.data[0].payload.data.config.channel_group.groups.Orderer.values.BatchSize.value.max_message_count&quot;
</code></pre>

<p>然后，让我们显示这个属性的值：</p>
<pre><code>$ jq &quot;$MAXBATCHSIZEPATH&quot; genesis_block.json
10
</code></pre>

<p>现在，我们设置新的批大小，并显示这个新值：</p>
<pre><code>$ jq “$MAXBATCHSIZEPATH = 20” genesis_block.json &gt; updated_genesis_block.json
$ jq “$MAXBATCHSIZEPATH” updated_genesis_block.json
20
</code></pre>

<p>创世区块现在准备好被重编码为用于自举的原生proto格式：</p>
<pre><code>$ curl -X POST --data-binary @updated_genesis_block.json http://127.0.0.1:7059/protolator/encode/common.Block &gt; updated_genesis_block.pb
</code></pre>

<p><code>updated_genesis_block.pb</code>文件现在可以作为创世区块用于一个排序系统通道的自举。</p>
<h3 id="_4">重新配置的例子<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p><em>（先用命令删除所有docker容器<code>docker rm -f $(docker ps -aq)</code>，否则byfn.sh启动的排序服务也会绑定端口7050）</em><br />
利用另外的终端窗口，使用默认配置启动排序服务，临时自举器会创建一个<code>testchainid</code>排序系统通道。</p>
<pre><code>ORDERER_GENERAL_LOGLEVEL=debug orderer
</code></pre>

<p>重新配置一个通道的操作非常类似于改变一个创世配置。</p>
<p><em>（现在configtxlator、orderer各占了一个终端窗口，下面需要启动第三个终端窗口）</em><br />
首先，取得配置区块proto：</p>
<pre><code>$ peer channel fetch config config_block.pb -o 127.0.0.1:7050 -c testchainid
-o 127.0.0.1:7050 -c testchainid
2017-12-11 09:00:15.658 UTC [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized
2017-12-11 09:00:15.660 UTC [main] main -&gt; INFO 002 Exiting.....
</code></pre>

<p><em>(当前目录下创建了文件<code>config_block.pb</code>)</em><br />
然后，发送配置区块到<code>configtxlator</code>服务进行解码：</p>
<pre><code>$ curl -X POST --data-binary @config_block.pb http://127.0.0.1:7059/protolator/decode/common.Block &gt; config_block.json
</code></pre>

<p>从区块中提取配置节：</p>
<pre><code>$ jq .data.data[0].payload.data.config config_block.json &gt; config.json
</code></pre>

<p>编辑配置，把它另存为一个新的<code>updated_config.json</code>。这里，我们设置批大小为30。</p>
<pre><code>$ jq &quot;.channel_group.groups.Orderer.values.BatchSize.value.max_message_count = 30&quot; config.json  &gt; updated_config.json
</code></pre>

<p>对原始配置和变更的配置进行重编码到proto格式：</p>
<pre><code>$ curl -X POST --data-binary @config.json http://127.0.0.1:7059/protolator/encode/common.Config &gt; config.pb
$ curl -X POST --data-binary @updated_config.json http://127.0.0.1:7059/protolator/encode/common.Config &gt; updated_config.pb
</code></pre>

<p>现在，两个配置都进行适当编码，发送它们到<em>configtxlator</em>服务，去计算它们之间的配置变更。</p>
<pre><code>$ curl -X POST -F original=@config.pb -F updated=@updated_config.pb http://127.0.0.1:7059/configtxlator/compute/update-from-configs -F channel=testchainid &gt; config_update.pb
</code></pre>

<p>这时，计算出来的配置变更已经准备好了。传统上，使用一个SDK签名和包装这个消息。然而，为了仅使用peer cli，<em>configtxlator</em>也可以用于完成这个任务。</p>
<p>首先，我们对配置变更(ConfigUPdate)进行解码，以便可以用文本方式操作它：</p>
<pre><code>$ curl -X POST --data-binary @config_update.pb http://127.0.0.1:7059/protolator/decode/common.ConfigUpdate &gt; config_update.json
</code></pre>

<p>然后，我们把它包裹进一个信封(envelope)消息：</p>
<pre><code>$ echo '{&quot;payload&quot;:{&quot;header&quot;:{&quot;channel_header&quot;:{&quot;channel_id&quot;:&quot;testchainid&quot;, &quot;type&quot;:2}},&quot;data&quot;:{&quot;config_update&quot;:'$(cat config_update.json)'}}}' &gt; config_update_as_envelope.json
</code></pre>

<p>接下来，将其转换回完整的配置交易的proto格式：</p>
<pre><code>$ curl -X POST --data-binary @config_update_as_envelope.json http://127.0.0.1:7059/protolator/encode/common.Envelope &gt; config_update_as_envelope.pb
</code></pre>

<p>最后，发送配置变更交易到排序服务去执行一个配置变更。</p>
<pre><code>$ peer channel update -f config_update_as_envelope.pb -c testchainid -o 127.0.0.1:7050
</code></pre>

<h3 id="_5">增加一个组织<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>先启动<code>configtxlator</code>：</p>
<pre><code>$ configtxlator start
2017-05-31 12:57:22.499 EDT [configtxlator] main -&gt; INFO 001 Serving HTTP requests on port: 7059
</code></pre>

<p>使用<code>SampleDevModeSolo</code>profile选项启动排序服务。</p>
<pre><code>$ ORDERER_GENERAL_LOGLEVEL=debug ORDERER_GENERAL_GENESISPROFILE=SampleDevModeSolo orderer
</code></pre>

<p>增加一个组织的过程与批大小的例子非常类似。然而，不同与设置批大小，一个新组织定义在应用级别。添加一个组织稍微牵扯一点，因为我们必须先创建一个通道，然后修改它的成员组成。<br />
关于利用configtxlator增加组织的更多内容参考<a href="https://github.com/wbwangk/wbwangk.github.io/wiki/Hyperledger#%E9%87%8D%E6%96%B0%E9%85%8D%E7%BD%AE%E9%A6%96%E4%B8%AA%E7%BD%91%E7%BB%9Cfirst-network">重新配置首个网络(First-Network)</a>。</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../endorsement-policies_zh/" class="btn btn-neutral float-right" title="背书策略">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../configtxgen_zh/" class="btn btn-neutral" title="Channel 配置(configtxgen)"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Hyperledger国际化工作组(yls@chainnova.com)</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/HyperledgerCN/hyperledgerDocs/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../configtxgen_zh/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../endorsement-policies_zh/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
