<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Hyperledger国际化工作组">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>编写第一个应用 - Hyperledger中文文档</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u7f16\u5199\u7b2c\u4e00\u4e2a\u5e94\u7528";
    var mkdocs_page_input_path = "write_first_app_zh.md";
    var mkdocs_page_url = "/write_first_app_zh/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Hyperledger中文文档</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">欢迎</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../glossary/">词汇表</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../blockchain_zh/">简介</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../getting_started/">快速入门</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../protocol-spec_zh/">协议规范</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Fabric教程</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../build_network_zh/">构建第一个fabric网络</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">编写第一个应用</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#_1">编写首个应用</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#_2">建立开发环境</a></li>
        
            <li><a class="toctree-l4" href="#_4">注册用户</a></li>
        
            <li><a class="toctree-l4" href="#_6">查询账本</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../channel_update_zh/">重新配置第一个网络</a>
                </li>
                <li class="">
                    
    <a class="" href="../chaincode_zh/">Chaincode 指南</a>
                </li>
                <li class="">
                    
    <a class="" href="../chaincode_developers_zh/">Chaincode 开发手册</a>
                </li>
                <li class="">
                    
    <a class="" href="../chaincode_operators_zh/">Chaincode 操作手册</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Fabric操作指南</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../msp_zh/">MSP</a>
                </li>
                <li class="">
                    
    <a class="" href="../configtx_zh/">Channel 配置(configtx)</a>
                </li>
                <li class="">
                    
    <a class="" href="../configtxgen_zh/">Channel 配置(configtxgen)</a>
                </li>
                <li class="">
                    
    <a class="" href="../configtxlator_zh/">Channel 重新配置(configtxlator)</a>
                </li>
                <li class="">
                    
    <a class="" href="../endorsement-policies_zh/">背书策略</a>
                </li>
                <li class="">
                    
    <a class="" href="../error-handling_zh/">错误处理</a>
                </li>
                <li class="">
                    
    <a class="" href="../logging-control_zh/">日志控制</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Fabric设计</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../arch-deep-dive_zh/">架构说明</a>
                </li>
                <li class="">
                    
    <a class="" href="../txflow_zh/">交易流程</a>
                </li>
                <li class="">
                    
    <a class="" href="../ca-setup_zh/">CA</a>
                </li>
                <li class="">
                    
    <a class="" href="../sdk_node_zh/">SDK--node</a>
                </li>
                <li class="">
                    
    <a class="" href="../sdk_java_zh/">SDK--java</a>
                </li>
                <li class="">
                    
    <a class="" href="../kafka_zh/">基于kafka的排序服务</a>
                </li>
                <li class="">
                    
    <a class="" href="../channels_zh/">Channels</a>
                </li>
                <li class="">
                    
    <a class="" href="../ledger_zh/">账本</a>
                </li>
                <li class="">
                    
    <a class="" href="../read-write-set/">Read-Write set</a>
                </li>
                <li class="">
                    
    <a class="" href="../gossip_zh/">Gossip数据传输协议</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">故障排除和常见问题</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Fabric-FAQ/">Hyperledger Fabric 答疑</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../msp_acl_zh/">MSP&ACL</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../sdk-design_zh/">Fabric SDK 设计</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../makefile_zh/">Makefile文件解析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../blockchain-crypto-service-provider_zh/">BCCSP密码算法套件解析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../zanata_guide/">Zanata使用指南</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Hyperledger中文文档</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Fabric教程 &raquo;</li>
        
      
    
    <li>编写第一个应用</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/HyperledgerCN/hyperledgerDocs/edit/master/docs/write_first_app_zh.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a href="http://hyperledger-fabric.readthedocs.io/en/latest/write_first_app.html">原文</a>  </p>
<h2 id="_1">编写首个应用<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>在实践本章前，请按<a href="https://github.com/wbwangk/wbwangk.github.io/wiki/Hyperledger#%E5%90%AF%E5%8A%A8%E9%A6%96%E4%B8%AA%E7%BD%91%E7%BB%9Cfirst-network">启动首个网络(first-network)</a>一章的描述准备好环境。<br />
本章原文是官网的<a href="http://hyperledger-fabric.readthedocs.io/en/latest/write_first_app.html">Writing Your First Application</a><br />
本章的工作目录是<code>/opt/fabric-samples/fabcar</code>。<br />
在本章中，首先访问CA生成注册证书(ECert)，然后利用生成的身份(用户对象)查询和更新账本。  </p>
<h3 id="_2">建立开发环境<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>可以通过执行下列命令停止“first-network”一章中的各种容器：</p>
<pre><code>$ cd /opt/fabric-samples/fabcar
$ ../first-network/byfn.sh -m down
</code></pre>

<p>或使用docker命令删除所有容器(可以与上面的命令混合使用)：</p>
<pre><code>$ docker rm -f $(docker ps -aq)
</code></pre>

<p>删除所有缓存网络：</p>
<pre><code>$ docker network prune
</code></pre>

<h4 id="_3">安装客户端和启动网络<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p><code>/opt/fabric-samples/fabcar</code>目录下有个<code>package.json</code>文件，定义了示范应用的依赖包，通过执行下列命令安装依赖（与java的maven类似）：</p>
<pre><code>$ npm install
</code></pre>

<p>使用脚本<code>startFabric.sh</code>启动网络。这个命令会启动几个Fabric实体和一个智能合约容器(链码)。</p>
<pre><code>$ ./startFabric.sh
$ docker ps
</code></pre>

<p>用上述docker命令可以看到启动的容器清单。  </p>
<h3 id="_4">注册用户<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<h4 id="_5">注册管理员用户<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>前面的<code>startFabric.sh</code>命令会启动一个CA容器，可以通过下列命令查看CA容器的日志：</p>
<pre><code>$ docker logs -f ca.example.com
</code></pre>

<p>执行下列命令来注册admin用户：</p>
<pre><code>$ node enrollAdmin.js
</code></pre>

<p>上述代码会向创建目录<code>hfc-key-store</code>，创建私钥，向CA发送证书签名请求(CSR)，然后把返回的CA签名证书(eCert)存放在<code>hfc-key-store</code>目录。  </p>
<h4 id="user1">注册用户user1<a class="headerlink" href="#user1" title="Permanent link">&para;</a></h4>
<p>admin用户是运维人员用的管理员证书。在一般的业务场景下，应用程序使用“普通用户”(非管理员)来访问Fabric网络。需要说明的是，向Fabric网络注册普通用户需要使用管理员身份，如现在就是用admin身份来注册<code>user1</code>用户。  </p>
<pre><code>$ node registerUser.js
</code></pre>

<p>与注册admin用户类似，代码会创建user1用户私钥，向CA发送证书签名请求(CSR)，并将返回的CA签名证书(eCert)存放在<code>hfc-key-store</code>目录。  </p>
<h3 id="_6">查询账本<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>用<code>docker ps</code>命令可以看到一个<code>hyperledger/fabric-couchdb</code>的容器，这是一个保存“世界状态”的key-value数据库(couchdb)。查询账本实际上就是在查询key-value数据库中的数据（数据库变化日志保存在区块链中）。查询参数一般是一个或几个key，也可以用json串当参数进行复杂查询。<br />
演示查询的代码文件是<code>query.js</code>，其中可以看到下面的代码，说明应用使用<code>user1</code>作为签名实体。</p>
<pre><code>fabric_client.getUserContext('user1', true);
</code></pre>

<p>user1的身份证明材料已经放在了<code>hfc-key-store</code>目录下，我们简单地告诉应用去获取身份。  </p>
<pre><code>$ node query.js
</code></pre>

<p>会返回一个json串，里面是全部10辆车的信息。<br />
观察一下<code>query.js</code>源码。在应用的初始化区段，定义了几个变量，如通道名称、证书库地址和网络端点。</p>
<pre><code class="js">var channel = fabric_client.newChannel('mychannel');
var peer = fabric_client.newPeer('grpc://localhost:7051');
channel.addPeer(peer);

var member_user = null;
var store_path = path.join(__dirname, 'hfc-key-store');
console.log('Store path:'+store_path);
var tx_id = null;
</code></pre>

<p>下面是执行查询的代码：</p>
<pre><code class="js">// queryCar chaincode function - requires 1 argument, ex: args: ['CAR4'],
// queryAllCars chaincode function - requires no arguments , ex: args: [''],
const request = {
  //targets : --- letting this default to the peers assigned to the channel
  chaincodeId: 'fabcar',
  fcn: 'queryAllCars',
  args: ['']
};
</code></pre>

<p>应用执行时，它调用了peer的<code>fabcar</code>链码，执行其中的<code>queryAllCars</code>函数。 
如果想看看有哪些链码函数可以调用，可以打开文件<code>../chaincode/fabcar/go/fabcar.go</code>来看。可以看到下列函数可以调用：<code>initLedger</code>, <code>queryCar</code>, <code>queryAllCars</code>, <code>createCar</code>和<code>changeCarOwner</code>。<br />
下图图示了应用、智能合约和账本的关系：<br />
<img alt="" src="http://hyperledger-fabric.readthedocs.io/en/latest/_images/RunningtheSample.png" /><br />
下面示范一下调用链码的<code>queryCar</code>函数来查询某一辆车的信息。将<code>query.js</code>中的<code>queryAllCars</code>函数换成<code>quieryCar</code>，参数key是<code>CAR4</code>。</p>
<pre><code class="js">const request = {
  //targets : --- letting this default to the peers assigned to the channel
  chaincodeId: 'fabcar',
  fcn: 'queryCar',
  args: ['CAR4']
};
</code></pre>

<p>保存<code>query.js</code>，并执行，可以看到返回了<code>CAR4</code>的车辆信息：</p>
<pre><code>$ node query.js
{&quot;colour&quot;:&quot;black&quot;,&quot;make&quot;:&quot;Tesla&quot;,&quot;model&quot;:&quot;S&quot;,&quot;owner&quot;:&quot;Adriana&quot;}
</code></pre>

<h4 id="_7">更新账本<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p>更新账本的过程：先提议，后背书，结果返回到应用，然后发送给排序节点，再写到各个peer的账本。<br />
<img alt="" src="http://hyperledger-fabric.readthedocs.io/en/latest/_images/UpdatingtheLedger.png" /><br />
js文件<code>invoke.js</code>是更新账本的程序示范。首先可以看到程序中构造请求的代码：</p>
<pre><code class="js">var request = {
  //targets: let default to the peer assigned to the client
  chaincodeId: 'fabcar',
  fcn: 'createCar',
  args: ['CAR10', 'Chevy', 'Volt', 'Red', 'Nick'],
  chainId: 'mychannel',
  txId: tx_id
};
</code></pre>

<p>在代码中通过调用链码<code>fabcar</code>的<code>createCar</code>函数，试图创建一个10号车(key是<code>CAR10</code>)。执行<code>invoke.js</code>：</p>
<pre><code>$ node invoke.js
Store path:/opt/fabric-samples/fabcar/hfc-key-store
Successfully loaded user1 from persistence
Assigning transaction_id:  1adb925d24db20816bcfc97f0216f3b094f3291778af775c1d07d0d3179a3031
Transaction proposal was good
Successfully sent Proposal and received ProposalResponse: Status - 200, message - &quot;OK&quot;
info: [EventHub.js]: _connect - options {&quot;grpc.max_receive_message_length&quot;:-1,&quot;grpc.max_send_message_length&quot;:-1}
The transaction has been committed on peer localhost:7053
Send transaction promise and event listener promise have completed
Successfully sent transaction to the orderer.
Successfully committed the change to the ledger by the peer
</code></pre>

<p>从上面可以看到关于<code>ProposalResponse</code>的终端输出和promise(一个异步调用标准)。上文的<code>The transaction has been committed on peer localhost:7053</code>表示事务已经成功写到peer。下面可以回到<code>query.js</code>，将查询条件由<code>CAR4</code>改成<code>CAR10</code>：</p>
<pre><code class="js">const request = {
  //targets : --- letting this default to the peers assigned to the channel
  chaincodeId: 'fabcar',
  fcn: 'queryCar',
  args: ['CAR10']
};
</code></pre>

<p>重新执行<code>query.js</code>可以查询到最新添加的10号车的信息：</p>
<pre><code>$ node query.js
Response is  {&quot;colour&quot;:&quot;Red&quot;,&quot;make&quot;:&quot;Chevy&quot;,&quot;model&quot;:&quot;Volt&quot;,&quot;owner&quot;:&quot;Nick&quot;}
</code></pre>

<p>下面重新修改代码<code>invoke.js</code>。将函数<code>createCar</code>改成<code>changeCarOwner</code>，目的是把10号车的车主改成<code>Dave</code>：</p>
<pre><code class="js">var request = {
  //targets: let default to the peer assigned to the client
  chaincodeId: 'fabcar',
  fcn: 'changeCarOwner',
  args: ['CAR10', 'Dave'],
  chainId: 'mychannel',
  txId: tx_id
};
</code></pre>

<p>重新执行<code>invoke.js</code>和<code>query.js</code>，可以看到车主信息被从<code>Nick</code>改成了<code>Dave</code>。</p>
<pre><code>$ node invoke.js
$ node query.js
Response is  {&quot;colour&quot;:&quot;Red&quot;,&quot;make&quot;:&quot;Chevy&quot;,&quot;model&quot;:&quot;Volt&quot;,&quot;owner&quot;:&quot;Dave&quot;}
</code></pre>

<p>本章主要讲应用开发，后面的章节会讲链码的开发。  </p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../channel_update_zh/" class="btn btn-neutral float-right" title="重新配置第一个网络">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../build_network_zh/" class="btn btn-neutral" title="构建第一个fabric网络"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Hyperledger国际化工作组(yls@chainnova.com)</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/HyperledgerCN/hyperledgerDocs/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../build_network_zh/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../channel_update_zh/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
